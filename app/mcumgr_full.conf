# MCUmgr Full Configuration
# Use this file to enable complete MCUmgr functionality
# Build with: west build -- -DEXTRA_CONF_FILE=mcumgr_full.conf

#==============================================================================
# MCUmgr Core Configuration
#==============================================================================

# Enable MCUmgr subsystem
CONFIG_MCUMGR=y

# SMP (Simple Management Protocol) - The protocol MCUmgr uses
CONFIG_BASE64=y
CONFIG_CRC=y
CONFIG_CBOR=y

#==============================================================================
# Transport Configuration - UART over USB
#==============================================================================

CONFIG_MCUMGR_TRANSPORT_UART=y
CONFIG_MCUMGR_TRANSPORT_UART_MTU=256

# For faster uploads, try:
# CONFIG_MCUMGR_TRANSPORT_UART_MTU=512

# SMP over UART
CONFIG_MCUMGR_SMP_UART=y
CONFIG_UART_ASYNC_API=y

#==============================================================================
# MCUmgr Command Groups
#==============================================================================

# Image Management - Upload/test/confirm firmware
CONFIG_MCUMGR_GRP_IMG=y
CONFIG_MCUMGR_GRP_IMG_UPLOAD_CHECK_HOOK=y
CONFIG_MCUMGR_GRP_IMG_STATUS_HOOKS=y

# OS Management - Reset, echo, datetime, taskstat
CONFIG_MCUMGR_GRP_OS=y
CONFIG_MCUMGR_GRP_OS_RESET_HOOK=y
CONFIG_MCUMGR_GRP_OS_TASKSTAT=y
CONFIG_MCUMGR_GRP_OS_ECHO=y
CONFIG_MCUMGR_GRP_OS_INFO=y

# Statistics Management - Get device stats
CONFIG_MCUMGR_GRP_STAT=y
CONFIG_STATS=y
CONFIG_STATS_NAMES=y

# Shell Management - Execute shell commands remotely
CONFIG_MCUMGR_GRP_SHELL=y

# File System Management (optional)
# CONFIG_MCUMGR_GRP_FS=y
# CONFIG_FILE_SYSTEM=y
# CONFIG_FILE_SYSTEM_LITTLEFS=y

# Logging Management (optional)
# CONFIG_MCUMGR_GRP_LOG=y

#==============================================================================
# Image Manager - Flash and Image Handling
#==============================================================================

CONFIG_IMG_MANAGER=y
CONFIG_IMG_ENABLE_IMAGE_CHECK=y
CONFIG_FLASH=y
CONFIG_FLASH_PAGE_LAYOUT=y
CONFIG_FLASH_MAP=y
CONFIG_STREAM_FLASH=y

# Storage partition for images
CONFIG_BOOTLOADER_MCUBOOT=y

#==============================================================================
# MCUboot Configuration
#==============================================================================

# Signing key (CHANGE THIS PATH if needed)
CONFIG_MCUBOOT_SIGNATURE_KEY_FILE="bootloader/mcuboot-rsa-2048.pem"

# Image version (can be overridden at build time)
CONFIG_MCUBOOT_IMGTOOL_SIGN_VERSION="1.0.0"

# Boot algorithm
CONFIG_BOOT_SWAP_USING_MOVE=y

# Security features
# CONFIG_MCUBOOT_DOWNGRADE_PREVENTION=y  # Uncomment for production
# CONFIG_MCUBOOT_HW_DOWNGRADE_PREVENTION=y

# Validate image before booting
CONFIG_MCUBOOT_VALIDATE_PRIMARY_SLOT=y

#==============================================================================
# Memory Configuration - Increased for MCUmgr
#==============================================================================

# Stack sizes for MCUmgr operations
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2304
CONFIG_MAIN_STACK_SIZE=4096

# Heap (if using malloc)
# CONFIG_HEAP_MEM_POOL_SIZE=4096

#==============================================================================
# Logging Configuration
#==============================================================================

CONFIG_LOG=y
CONFIG_LOG_DEFAULT_LEVEL=3  # 3=INFO, 4=DEBUG
CONFIG_MCUBOOT_LOG_LEVEL_INF=y

# Log backends
CONFIG_LOG_BACKEND_UART=y
CONFIG_LOG_BACKEND_SHOW_COLOR=n  # Disable colors for cleaner MCUmgr output

#==============================================================================
# System Features
#==============================================================================

# Reboot support (required for MCUmgr reset)
CONFIG_REBOOT=y

# Thread monitoring (for taskstat command)
CONFIG_THREAD_MONITOR=y
CONFIG_THREAD_NAME=y
CONFIG_THREAD_RUNTIME_STATS=y

#==============================================================================
# Optional: Bluetooth Transport (for wireless DFU)
#==============================================================================

# Uncomment to enable BLE DFU:
# CONFIG_MCUMGR_TRANSPORT_BT=y
# CONFIG_MCUMGR_SMP_BT=y
# CONFIG_MCUMGR_SMP_BT_AUTHEN=n  # Set to 'y' for pairing requirement

#==============================================================================
# Debugging and Development
#==============================================================================

# Enable for debugging MCUmgr issues
# CONFIG_MCUMGR_LOG_LEVEL_DBG=y
# CONFIG_LOG_DEFAULT_LEVEL=4

# Assertions for safety
CONFIG_ASSERT=y
CONFIG_ASSERT_LEVEL=2

#==============================================================================
# End of Configuration
#==============================================================================

# Build with this config:
#   west build -b nrf52840dk_nrf52840 -- -DEXTRA_CONF_FILE=mcumgr_full.conf
#
# Then flash:
#   west flash
#
# Test MCUmgr:
#   mcumgr --conntype serial --connstring dev=/dev/ttyACM0 echo hello

